# 開発指示書: AI Agent Orchestration Platform

**To:** IDE Assistant "Kiro"
**Subject:** ブラウザ完結型・GitHub Pages公開に向けた統合実装方針

これまでの設計要件に基づき、「AI Agent Orchestration Platform」の実装を開始します。
本プロジェクトは**GitHub Pagesでの静的ホスティング**を前提とし、バックエンドレスで動作する堅牢なアプリケーションを目指します。以下の技術選定と実装方針を厳守してください。

## 1. プロジェクト基本方針
*   **完全ブラウザ完結 (Serverless):** 独自のバックエンドサーバーは構築しません。
*   **デプロイ先:** GitHub Pages (静的サイト)。
*   **API通信:** ブラウザクライアントから OpenRouter API を直接呼び出します。

## 2. セキュリティと認証（最重要）
GitHub上のパブリックリポジトリで公開するため、APIキーの管理には細心の注意を払ってください。
*   **❌ 禁止事項:**
    *   ソースコード内へのAPIキーのハードコーディング。
    *   `.env` ファイルへのAPIキーの保存（誤ってコミットされるリスクの完全排除）。
*   **✅ 実装方針:**
    *   **設定画面の実装:** ユーザーが自身のOpenRouter APIキーを入力するUIを作成する。
    *   **保存先:** 入力されたキーは `LocalStorage` にのみ保存し、APIリクエスト時にそこから読み出す。

## 3. アーキテクチャとデータ戦略
パフォーマンスと開発効率のため、以下のライブラリとパターンを採用します。

### A. ストレージ戦略 (IndexedDB + Dexie.js)
*   **LocalStorage:** 設定、APIキー、エージェント定義などの「軽量データ」のみ。
*   **IndexedDB (via Dexie.js):**
    *   チャット履歴、タスク実行結果、システムログなどの「重量データ」は全てこちらで管理。
    *   *Action:* `npm install dexie` を実行し、型安全なDBラッパーを実装すること。

### B. 並列処理とタイマー管理 (Web Workers)
ブラウザのバックグラウンドタブによるスロットリング対策を行います。
*   **Web Workersの役割:**
    *   重い計算処理に加え、**「APIポーリング」や「タイマー管理（setInterval）」もWorker内で実行**する。
    *   メインスレッド（UI）が停止しても、エージェントの思考プロセスが止まらない設計にする。

### C. ビルド設定 (Vite)
*   **Base Path:** GitHub Pages対応のため、`vite.config.ts` の `base` 設定をリポジトリ名に合わせて変更可能にしておくこと（初期値は `'./'` 推奨）。
*   **PWA化 (推奨):** `vite-plugin-pwa` を導入し、アプリとしてインストール可能な構成にする。

## 4. 安全対策（サーキットブレーカー）
AIの暴走による課金事故を防ぐため、以下の機能を**初期実装**に含めます。
1.  **最大反復制限 (Max Iterations):** 1タスクあたりの実行回数上限（例: 10回）を設け、到達したら強制終了する。
2.  **緊急停止ボタン (Kill Switch):** 画面の常時見える位置に、全エージェントとタスクキューを即時停止・破棄するボタンを配置する。

## 5. 通信・モデル・UX設計
### A. API通信とストリーミング
*   **ストリーミング必須:** OpenRouter APIの `stream: true` を使用し、Fetch APIの `ReadableStream` でトークン生成ごとにUIをリアルタイム更新すること。
*   **ヘッダー設定:** CORS対策およびマナーとして以下を含める。
    *   `Authorization`: `Bearer ${user_api_key}`
    *   `HTTP-Referer`: `window.location.href`
    *   `X-Title`: "AI Agent Orchestration Platform"

### B. モデル選択の柔軟性
*   デフォルトは `xiaomi/mimo-v2-flash:free` とするが、設定画面でユーザーが任意のモデルID（例: `anthropic/claude-3-haiku` 等）に変更・保存できる実装にする。

## 6. デバッグと可観測性 (Observability)
マルチエージェントの挙動を追跡可能にするため、ログシステムを実装してください。
*   **構造化ログ:**
    *   `{ timestamp, agentId, type, content, metadata }` の形式でログを扱う。
    *   これらを **UI上の「ログコンソール」パネル** に表示し、かつ **IndexedDB** に保存する。

## 7. 品質保証 (Testing Strategy)
プロジェクト要件に基づき、堅牢性を確保してください。
*   **Property-based Testing:**
    *   `fast-check` ライブラリを使用し、以下のコアロジックに対してプロパティテストを作成すること。
        1.  **Task Queue:** 優先順位通りにタスクが取り出されるか。
        2.  **Workflow:** 循環参照が正しく検出・排除されるか。
        3.  **Storage:** 保存した設定が、リロード後も完全に復元されるか（Round-trip test）。

---

**Kiroへのアクション指示:**
以上の要件を理解した上で、まずは `src/` 以下のディレクトリ構造の再確認、必要なパッケージ（`dexie`, `vite-plugin-pwa`, `fast-check` 等）のインストール、および `Dexie.js` を用いたデータベース初期化コードの生成から開始してください。